<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial; padding: 20px; }
      input, textarea { margin-bottom: 10px; width: 300px; }
    </style>
  </head>
  <body>
    <h2>å­¸ç”Ÿç™»å…¥æŸ¥è©¢æˆç¸¾</h2>
    <form onsubmit="handleLogin(this); return false;">
      å­¸è™Ÿï¼š<input name="id" required><br>
      å¯†ç¢¼ï¼š<input name="password" type="password" required><br>
      <input type="submit" value="ç™»å…¥">
    </form>

    <div id="result" style="margin-top: 20px;"></div>

    <script>
      let currentUser = null;

      function handleLogin(form) {
        const user = {
          id: form.id.value,
          password: form.password.value
        };
        currentUser = user;
        google.script.run
          .withSuccessHandler(showGrades)
          .withFailureHandler(err => {
            document.getElementById('result').innerText = "âŒ éŒ¯èª¤ï¼š" + err.message;
          })
          .checkLogin(user);
      }

      function showGrades(result) {
        if (!result.success) {
          document.getElementById('result').innerHTML = "<p style='color:red;'>âŒ å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤</p>";
          return;
        }

        const grades = result.grades;
        let html = "<h3>ğŸ“‹ æˆç¸¾åˆ—è¡¨</h3><ul>";
        grades.forEach(g => {
          html += `<li>ç¬¬ ${g.week} é€±ï¼š${g.score} åˆ†</li>`;
        });
        html += "</ul>";

        html += `
          <h3>ğŸ§  æƒ³å•ç³»çµ±çš„å»ºè­°ï¼š</h3>
          <textarea id="studentPrompt" rows="3" placeholder="è¼¸å…¥ä½ æƒ³å•çš„å•é¡Œï¼Œä¾‹å¦‚ï¼šæˆ‘é€²æ­¥äº†å—ï¼Ÿ"></textarea><br>
          <button onclick="askGPT()">é€å‡ºå•é¡Œ</button>
          <div id="analysis" style="margin-top: 10px;"></div>
        `;

        document.getElementById('result').innerHTML = html;
      }

      function askGPT() {
        const prompt = document.getElementById('studentPrompt').value;
        if (!prompt || !currentUser) return;

        document.getElementById('analysis').innerText = "â³ åˆ†æä¸­...";

        google.script.run
          .withSuccessHandler(res => {
            document.getElementById('analysis').innerHTML = `<h4>åˆ†æçµæœï¼š</h4><p>${res}</p>`;
          })
          .withFailureHandler(err => {
            document.getElementById('analysis').innerText = "âŒ éŒ¯èª¤ï¼š" + err.message;
          })
          .analyzeByStudent(currentUser, prompt);
      }
    </script>
  </body>
</html>
